<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Blood Buddy - Online Blood Donors Directory</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .olive-gradient { background: linear-gradient(to right, #6b8e23, #556b2f); }
    .blue-gradient { background: linear-gradient(to right, #87ceeb, #5dade2); }
    .bg-gradient-custom { background: linear-gradient(to bottom, #f0f8ff, #f5fffa); }
  </style>
</head>
<body class="bg-gradient-custom min-h-screen">
  <div id="app"></div>

  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo } = React;

    /* ========== Icons (unchanged) ========== */
    const Users = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
        <circle cx="9" cy="7" r="4"/>
        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
      </svg>
    );
    const Phone = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
      </svg>
    );
    const Share2 = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="18" cy="5" r="3"></circle>
        <circle cx="6" cy="12" r="3"></circle>
        <circle cx="18" cy="19" r="3"></circle>
        <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line>
        <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line>
      </svg>
    );
    const Heart = ({ size = 24, fill = "none" }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth="2">
        <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
      </svg>
    );
    const Building2 = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"></path>
        <path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"></path>
        <path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"></path>
        <path d="M10 6h4"></path><path d="M10 10h4"></path><path d="M10 14h4"></path><path d="M10 18h4"></path>
      </svg>
    );
    const MapPin = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
        <circle cx="12" cy="10" r="3"></circle>
      </svg>
    );
    const Search = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
    );

    /* ========== helpers: sanitize + dedupe ========== */
    const sanitizeAndDedupe = (rawArray = []) => {
      if (!Array.isArray(rawArray)) return [];
      const seen = new Set();
      const out = [];

      for (let i = 0; i < rawArray.length; i++) {
        const it = rawArray[i];
        if (!it || typeof it !== 'object') continue; // drop non-objects
        // normalize phone: keep as string and trim
        const number = it.number ? String(it.number).trim() : '';
        const name = it.name ? String(it.name).trim() : '';
        const bloodGroup = it.bloodGroup ? String(it.bloodGroup).trim() : '';
        const place = it.place ? String(it.place).trim() : '';

        // Use phone as primary unique key; fall back to name+place
        const key = number || (name + '|' + place);
        if (seen.has(key)) continue;
        seen.add(key);

        out.push({
          name,
          bloodGroup,
          number,
          place
        });
      }

      return out;
    };

    /* ========== submit to Google Sheet (unchanged) ========== */
    const submitToSheet = async (formData) => {
      try {
        await fetch("https://script.google.com/macros/s/AKfycbx2SV0qwwEMwSmQwCaTp8A9htEuQ37HzkZhcIuO5SJTs9ZWAvyintKSzpCZD9lPchO_/exec", {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: formData.name,
            bloodGroup: formData.bloodGroup,
            phone: formData.number,
            place: formData.place
          })
        });
      } catch (err) {
        console.error("Submit failed", err);
        throw err;
      }
    };

    /* ========== App ========== */
    const BloodDonorApp = () => {
      const [donors, setDonors] = useState([]);
      const [filteredDonors, setFilteredDonors] = useState([]);
      const [loading, setLoading] = useState(true);
      const [selectedBloodGroup, setSelectedBloodGroup] = useState('');
      const [searchQuery, setSearchQuery] = useState('');
      const [activeTab, setActiveTab] = useState('search');
      const [showBeABuddy, setShowBeABuddy] = useState(false);
      const [currentPage, setCurrentPage] = useState(1);
      const [contentKey, setContentKey] = useState('search-1'); // force remount of content when tab changes

      const itemsPerPage = 5;

      const bloodGroups = ['A +ve', 'A -ve', 'B +ve', 'B -ve', 'AB +ve', 'AB -ve', 'O +ve', 'O -ve'];

      const bloodBanks = [
        { name: 'Thrissur Govt Medical College Blood Bank', phone: '+91-0487-2421340', place: 'Thrissur' },
        { name: 'Caritas Hospital Blood Bank', phone: '+91-0484-2383333', place: 'Kottayam' },
        { name: 'Lakeshore Hospital Blood Bank', phone: '+91-0484-2701032', place: 'Kochi' },
        { name: 'IMA Blood Bank', phone: '+91-0487-2333518', place: 'Thrissur' },
        { name: 'Kerala Institute of Medical Sciences', phone: '+91-0471-3041400', place: 'Trivandrum' }
      ];

      /* Load donors.json once and sanitize/dedupe */
      useEffect(() => {
        let mounted = true;
        fetch('donors.json')
          .then(res => res.json())
          .then(raw => {
            if (!mounted) return;
            const clean = sanitizeAndDedupe(raw);
            console.debug('[load] donors loaded:', raw.length, '-> sanitized:', clean.length);
            setDonors(clean);
            setFilteredDonors(clean);
            setLoading(false);
          })
          .catch(err => {
            console.error('Error loading donors:', err);
            setLoading(false);
          });
        return () => { mounted = false; };
      }, []);

      /* When activeTab changes, clear filteredDonors if we move away from search.
         Also bump contentKey to force remount of the content container so no stale DOM remains. */
      useEffect(() => {
        // Force remount of content area to avoid any lingering DOM states
        setContentKey(`${activeTab}-${Date.now()}`);
        if (activeTab !== 'search') {
          // explicit clear to avoid donor items showing in non-search tabs
          setFilteredDonors([]);
        } else {
          // if switching back to search, reset filters (optional: keep existing filters)
          setCurrentPage(1);
        }
        console.debug('[tab] activeTab:', activeTab);
      }, [activeTab]);

      /* Filtering logic (sanitized) */
      useEffect(() => {
        // start from sanitized donors
        let list = Array.isArray(donors) ? donors.filter(Boolean) : [];

        if (selectedBloodGroup) {
          list = list.filter(d => (d.bloodGroup || '').trim() === selectedBloodGroup.trim());
        }

        if (searchQuery) {
          const q = searchQuery.toLowerCase();
          list = list.filter(d =>
            (d.name || '').toLowerCase().includes(q) ||
            (d.place || '').toLowerCase().includes(q) ||
            (d.number || '').includes(q)
          );
        }

        console.debug('[filter] selected:', selectedBloodGroup, 'q:', searchQuery, 'resultCount:', list.length);
        setFilteredDonors(list);
        setCurrentPage(1);
      }, [selectedBloodGroup, searchQuery, donors]);

      const totalPages = Math.ceil(filteredDonors.length / itemsPerPage);
      const currentDonors = filteredDonors.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

      const handleCall = (number) => window.location.href = `tel:${number}`;
      const handleShare = (donor) => {
        const message = `Blood Donor Contact:\nName: ${donor.name}\nBlood Group: ${donor.bloodGroup}\nNumber: ${donor.number}\nPlace: ${donor.place}\n\nFor more Donors please check https://rebrad.ly/bloodbuddy`;
        if (navigator.share) navigator.share({ title: 'Blood Donor', text: message });
        else window.open(`https://wa.me/?text=${encodeURIComponent(message)}`, '_blank');
      };

      const DonorCard = ({ donor, idx }) => (
        <div className="bg-white rounded-xl shadow-md p-4 mb-3 border-l-4 border-olive hover:shadow-lg transition-shadow">
          <div className="flex justify-between items-start mb-3">
            <div className="flex-1">
              <h3 className="font-bold text-lg text-gray-800">{donor.name}</h3>
              <div className="flex items-center gap-2 text-sm text-gray-600 mt-1">
                <MapPin size={14} />
                <span>{donor.place}</span>
              </div>
            </div>
            <span className="text-white px-3 py-1 rounded-full text-sm font-semibold whitespace-nowrap ml-2 olive-gradient">{donor.bloodGroup}</span>
          </div>
          <div className="text-gray-700 mb-3 font-medium">{donor.number}</div>
          <div className="flex gap-2">
            <button onClick={() => handleCall(donor.number)} className="flex-1 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all hover:opacity-90" style={{backgroundColor:'#6b8e23'}}><Phone size={18}/> Call</button>
            <button onClick={() => handleShare(donor)} className="flex-1 text-white py-2 px-4 rounded-lg flex items-center justify-center gap-2 transition-all hover:opacity-90" style={{backgroundColor:'#87ceeb'}}><Share2 size={18}/> Share</button>
          </div>
        </div>
      );

      const BeABuddyForm = () => {
        const [formData, setFormData] = useState({ name: '', bloodGroup: '', number: '', place: '' });
        const [submitting, setSubmitting] = useState(false);

        const handleSubmit = async () => {
          if (!formData.name || !formData.bloodGroup || !formData.number || !formData.place) {
            alert('Please fill all fields');
            return;
          }
          setSubmitting(true);
          try {
            // submit to sheet (no local state push)
            await submitToSheet(formData);
            alert(`Thanks ${formData.name}! You are now registered as a Blood Buddy ❤️`);
            setFormData({ name: '', bloodGroup: '', number: '', place: '' });
            setShowBeABuddy(false);
            // NOTE: We do NOT push the new donor into local `donors` state here.
            // If you want immediate local update, call setDonors(prev => sanitizeAndDedupe([formData, ...prev]))
            // but be careful to avoid double-adds if donors.json will later be reloaded.
          } catch (err) {
            alert('Submit failed. Please try again.');
            console.error(err);
          } finally {
            setSubmitting(false);
          }
        };

        return (
          <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-2xl p-6 max-w-md w-full max-h-[90vh] overflow-y-auto">
              <div className="flex items-center gap-3 mb-6"><Heart size={32} style={{color:'#6b8e23'}}/><h2 className="text-2xl font-bold">Be a Blood Buddy</h2></div>
              <div className="space-y-4">
                <div><label>Name</label><input type="text" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-300"/></div>
                <div><label>Blood Group</label><select value={formData.bloodGroup} onChange={e => setFormData({...formData, bloodGroup: e.target.value})} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-300"><option value="">Select</option>{bloodGroups.map(bg => <option key={bg} value={bg}>{bg}</option>)}</select></div>
                <div><label>Phone Number</label><input type="tel" value={formData.number} onChange={e => setFormData({...formData, number: e.target.value})} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-300"/></div>
                <div><label>Place</label><input type="text" value={formData.place} onChange={e => setFormData({...formData, place: e.target.value})} className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-300"/></div>
                <div className="flex gap-3">
                  <button onClick={() => setShowBeABuddy(false)} className="flex-1 bg-gray-300 py-3 rounded-lg">Cancel</button>
                  <button onClick={handleSubmit} disabled={submitting} className="flex-1 bg-green-600 text-white py-3 rounded-lg">{submitting ? 'Submitting...' : 'Register'}</button>
                </div>
              </div>
            </div>
          </div>
        );
      };

      return (
        <div className="min-h-screen relative">
          {/* Header */}
          <div className="text-white p-6 shadow-lg olive-gradient text-center">
            <h1 className="text-4xl font-bold">Blood Buddy</h1>
            <p className="text-yellow-400">Online Blood Group Directory</p>
          </div>

          {/* Tabs */}
          <div className="flex bg-white shadow-md sticky top-0 z-40">
            <button onClick={() => setActiveTab('search')} className="flex-1 py-4 font-semibold transition-colors" style={{color: activeTab==='search' ? '#87ceeb' : '#666', borderBottom: activeTab==='search' ? '2px solid #87ceeb' : 'none'}}><Users className="inline mr-2"/> Find Donors</button>
            <button onClick={() => setActiveTab('bloodbanks')} className="flex-1 py-4 font-semibold transition-colors" style={{color: activeTab==='bloodbanks' ? '#87ceeb' : '#666', borderBottom: activeTab==='bloodbanks' ? '2px solid #87ceeb' : 'none'}}><Building2 className="inline mr-2"/> Blood Banks</button>
          </div>

          {/* Filters (sticky) */}
          {activeTab === 'search' && (
            <div className="p-4 sticky top-[64px] bg-gradient-custom z-30">
              <div className="mb-4">
                <select value={selectedBloodGroup} onChange={e => setSelectedBloodGroup(e.target.value)} className="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-300">
                  <option value="">All Blood Groups ({donors.length})</option>
                  {bloodGroups.map(bg => <option key={bg} value={bg}>{bg}</option>)}
                </select>
              </div>
              <div className="relative mb-4">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"/>
                <input type="text" value={searchQuery} onChange={e => setSearchQuery(e.target.value)} placeholder="Search by name, place or number" className="w-full pl-10 py-3 border rounded-lg focus:ring-2 focus:ring-blue-300"/>
              </div>
            </div>
          )}

          {/* Main content area - keyed by contentKey to force remount when tab changes */}
          <div key={contentKey} className="p-4 max-w-4xl mx-auto mb-24">
            {loading ? (
              <p className="text-center">Loading...</p>
            ) : activeTab === 'search' ? (
              <>
                {currentDonors.length ? currentDonors.map((d, idx) => <DonorCard key={(d.number || d.name || idx)} donor={d} idx={idx} />) : <p className="text-center text-gray-500 mt-10">No donors found.</p>}

                {totalPages > 1 && (
                  <div className="flex justify-center mt-4 gap-2">
                    <button onClick={() => setCurrentPage(p => Math.max(1, p - 1))} disabled={currentPage === 1} className="px-3 py-1 border rounded">Prev</button>
                    <span className="px-3 py-1">{currentPage}/{totalPages}</span>
                    <button onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))} disabled={currentPage === totalPages} className="px-3 py-1 border rounded">Next</button>
                  </div>
                )}
              </>
            ) : (
              /* Blood Banks tab - donor cards explicitly removed by clearing filteredDonors above */
              <>
                {bloodBanks.map(bank => (
                  <div key={bank.name} className="bg-white rounded-xl shadow-md p-4 mb-3 border-l-4 border-blue-400">
                    <div className="flex justify-between items-start mb-2">
                      <h3 className="font-bold text-lg text-gray-800">{bank.name}</h3>
                      <span className="text-sm text-gray-600">{bank.place}</span>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => handleCall(bank.phone)} className="flex-1 text-white py-2 px-4 rounded-lg flex items-center gap-2 transition-all hover:opacity-90" style={{backgroundColor:'#6b8e23'}}><Phone size={18}/> Call</button>
                      <button onClick={() => handleShare({ name: bank.name, bloodGroup: '', number: bank.phone, place: bank.place })} className="flex-1 text-white py-2 px-4 rounded-lg flex items-center gap-2 transition-all hover:opacity-90" style={{backgroundColor:'#87ceeb'}}><Share2 size={18}/> Share</button>
                    </div>
                  </div>
                ))}
              </>
            )}
          </div>

          {/* Floating button */}
          {activeTab === 'search' && (
            <button onClick={() => setShowBeABuddy(true)} className="fixed bottom-6 right-6 bg-green-600 text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-2 hover:opacity-90 z-50"><Heart size={20}/> Be a Blood Buddy</button>
          )}

          {showBeABuddy && <BeABuddyForm />}
          {/* Developer Footer */}
          <div className="fixed bottom-0 left-0 w-full text-center text-[10px] text-gray-700 py-1 bg-white bg-opacity-80 z-40">
            Developed by Navas Abdulkader
          </div>
        </div>
      );
    };

    ReactDOM.render(<BloodDonorApp />, document.getElementById('app'));
  </script>
</body>
</html>
